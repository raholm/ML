## ---- assign2-init
set.seed(1234567890)
spam <- read.csv2("../data/spambase.csv")

ind <- sample(1:nrow(spam))
spam <- spam[ind,c(1:48,58)]
spam$Spam <- 2 * spam$Spam - 1

gaussian_k <- function(x, h) {
    exp(-(x / h)^2)
}

euclidean_d <- function(x, xi) {
    x <- t(as.matrix(x))
    xi <- as.numeric(xi)
    sqrt(colSums((x - xi)^2))
    ## d <- dist(rbind(x, xi))
    ## d[(length(d) - nrow(x) + 1):length(d)]
}

SVM <- function(sv, i) {
    h <- 1
    b <- 0
    x <- sv[, -ncol(sv)]
    t <- sv[, ncol(sv)]

    predicted <- sum(t * gaussian_k(euclidean_d(x, i), h)) + b
    predicted
}

sv.least_important <- function(sv) {
    which.max(lapply(sv, function(m) {
        obs <- spam[m,]
        x <- obs[, -ncol(obs)]
        t <- obs$Spam
        y <- SVM(spam[sv,], x)
        h <- 1
        k <- gaussian_k(euclidean_d(x, x), h)
        t * (y - t * k)
    }))
}

run_BOSVM <- function(data, beta, M, N) {
    errors <- 1
    errorrate <- vector(length = N)
    errorrate[1] <- 1
    sv <- c(1)

    for(i in 2:N) {
        predicted <- SVM(data[sv,], data[i, -ncol(data)])

        if (data[i, "Spam"] * predicted < beta) {
            sv <- c(sv, i)
            errors <- errors + 1

            if (length(sv) > M) {
                sv <- sv[-sv.least_important(sv)]
            }
        }

        errorrate[i] <- errors / i
    }
    list(errorrate=errorrate, sv=sv)
}

N <- 500
## ---- end-of-assign2-init

## ---- assign2-run1
result <- run_BOSVM(data=spam, beta=0, M=500, N=N)
cat(paste("Number of Suppoer Vectors:", length(result$sv)))
plot(result$errorrate[seq(from=1, to=N, by=10)],
     type="o", main="Beta=0, M=500")
## ---- end-of-assign2-run1

## ---- assign2-run2
result <- run_BOSVM(data=spam, beta=-0.05, M=500, N=N)
cat(paste("Number of Suppoer Vectors:", length(result$sv)))
plot(result$errorrate[seq(from=1, to=N, by=10)],
     type="o", main="Beta=-0.05, M=500")
## ---- end-of-assign2-run2

## ---- assign2-run3
result <- run_BOSVM(data=spam, beta=0, M=20, N=N)
cat(paste("Number of Suppoer Vectors:", length(result$sv)))
plot(result$errorrate[seq(from=1, to=N, by=10)],
     type="o", main="Beta=0, M=20")
## ---- end-of-assign2-run3

## ---- assign2-run4
result <- run_BOSVM(data=spam, beta=-0.05, M=20, N=N)
cat(paste("Number of Suppoer Vectors:", length(result$sv)))
plot(result$errorrate[seq(from=1, to=N, by=10)],
     type="o", main="Beta=-0.05, M=20")
## ---- end-of-assign2-run4
